{% extends 'base.html' %}
{% load static %}
{% block title %}{{ food_item.name }} - Ghar Ko Swad{% endblock %}
{% block content %}
<section class="py-5">
    <div class="container">
        <div class="row g-4">
            <div class="col-lg-6">
                <div class="card border-0 shadow-sm">
                    <img src="{% if food_item.image %}{{ food_item.image.url }}{% elif food_item.image_url %}{{ food_item.image_url }}{% else %}https://images.pexels.com/photos/2233729/pexels-photo-2233729.jpeg?auto=compress&cs=tinysrgb&w=1200{% endif %}" class="card-img-top" alt="{{ food_item.name }}">
                </div>
            </div>
            <div class="col-lg-6">
                <h1 class="h3 fw-bold mb-2">{{ food_item.name }}</h1>
                <div class="mb-2">
                    <span class="text-warning">{% for i in "12345" %}<i class="bi bi-star{% if avg_rating >= forloop.counter %}-fill{% endif %}"></i>{% endfor %}</span>
                    <small class="text-muted ms-2">{{ avg_rating }} ({{ review_count }} review{{ review_count|pluralize }})</small>
                </div>
                <p class="h4 text-success fw-semibold mb-3">₹{{ food_item.price }}</p>
                {% if not is_available %}<p class="alert alert-warning mb-3 mb-0">This item is no longer available for order (sold out / delivered).</p>{% endif %}
                <p class="text-muted">{% if food_item.description %}{{ food_item.description }}{% else %}Homemade with care by our chef.{% endif %}</p>
                <div class="mb-3">
                    <h2 class="h6 fw-bold mb-2">Prepared by</h2>
                    <div class="d-flex align-items-center">
                        <div class="rounded-circle bg-warning d-flex align-items-center justify-content-center me-2" style="width: 40px; height: 40px;">
                            <span class="fw-bold text-white">{% firstof food_item.chef.get_full_name|slice:":1" food_item.chef.email|slice:":1" "C" %}</span>
                        </div>
                        <div>
                            <div class="fw-semibold">{{ food_item.chef.get_full_name|default:food_item.chef.email }}</div>
                            <small class="text-muted">{% if food_item.chef.speciality %}{{ food_item.chef.speciality }}{% else %}Home chef{% endif %}</small>
                        </div>
                    </div>
                </div>
                <div class="d-flex flex-wrap gap-2">
                    {% if is_available %}
                    <a href="{% url 'core:order' %}?item={{ food_item.id }}" class="btn btn-primary">Order Now</a>
                    {% endif %}
                    <a href="{% url 'core:index' %}#recommended" class="btn btn-outline-secondary">Back to all dishes</a>
                </div>
            </div>
        </div>
    </div>
</section>

<section class="pb-5">
    <div class="container">
        <div class="row g-4">
            <div class="col-lg-6">
                <h2 class="h5 fw-bold mb-3">Customer Reviews</h2>
                {% for r in reviews %}
                <div class="list-group-item border-0 border-bottom mb-2">
                    <div class="d-flex justify-content-between">
                        <strong>{{ r.customer.get_full_name|default:r.customer.email }}</strong>
                        <span class="text-warning">{% for i in "12345" %}<i class="bi bi-star{% if r.rating >= forloop.counter %}-fill{% endif %}"></i>{% endfor %}</span>
                    </div>
                    <p class="mb-1">{{ r.text }}</p>
                    {% if r.chef_reply %}
                    <div class="bg-light rounded p-2 mt-2 small">
                        <strong class="text-primary">Chef reply:</strong> {{ r.chef_reply }}
                    </div>
                    {% endif %}
                    <small class="text-muted">{{ r.created_at|date:"M d, Y H:i" }}</small>
                </div>
                {% empty %}
                <p class="text-muted small">No reviews yet. Be the first to review!</p>
                {% endfor %}
            </div>
            <div class="col-lg-6">
                <h2 class="h5 fw-bold mb-3">Write a Review</h2>
                {% if user.is_authenticated and user_profile.role == 'customer' %}
                <form method="post" action="{% url 'core:food_details' food_item.id %}" class="card border-0 shadow-sm">
                    {% csrf_token %}
                    <div class="card-body">
                        <div class="mb-3">
                            <label class="form-label small">Your rating (1–5)</label>
                            <select name="rating" class="form-select" required>
                                <option value="">Select</option>
                                <option value="1">1 ★</option>
                                <option value="2">2 ★★</option>
                                <option value="3">3 ★★★</option>
                                <option value="4">4 ★★★★</option>
                                <option value="5">5 ★★★★★</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label class="form-label small">Your review</label>
                            <textarea name="review_text" class="form-control" rows="3" placeholder="Share your experience" required></textarea>
                        </div>
                        <button type="submit" class="btn btn-primary btn-sm">Submit Review</button>
                    </div>
                </form>
                {% else %}
                <p class="text-muted small">Please <a href="{% url 'core:login' %}">log in</a> as a customer to leave a review.</p>
                {% endif %}
            </div>
        </div>
    </div>
</section>
{% endblock %}
